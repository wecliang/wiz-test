var h=Object.defineProperty,y=Object.defineProperties;var g=Object.getOwnPropertyDescriptors;var m=Object.getOwnPropertySymbols;var b=Object.prototype.hasOwnProperty,x=Object.prototype.propertyIsEnumerable;var f=(i,e,t)=>e in i?h(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,u=(i,e)=>{for(var t in e||(e={}))b.call(e,t)&&f(i,t,e[t]);if(m)for(var t of m(e))x.call(e,t)&&f(i,t,e[t]);return i},d=(i,e)=>y(i,g(e));import{b as ajax,O as dynamicCreateModule,X as getQueryParam}from"./hoc.1518c0b9.js";import{g as getContextToFileData,h as getTypeContext,i as paramToStringify,j as InterfaceToSchema,k as Store$2,l as Store$3,m as moduleStore,n as MyComponent,A as AsyncButton,e as MyErrorBoundary,o as CustomPage}from"./index.4570827b.js";import"./vendor.96977194.js";import{j as jsx,a as jsxs}from"./index.77b54dbf.js";import"https://wizui-assets.oss-cn-hangzhou.aliyuncs.com/umd/arco.min.js";import"./index.b2d33ba3.js";import"./___vite-browser-external_commonjs-proxy.579575e7.js";import"https://static-s.gaiaworkforce.com/formPlatForm/umdjs/monaco/index.min.js";import"https://unpkg.com/react-dnd@14.0.5/dist/umd/ReactDnD.min.js";import"https://unpkg.com/react-dnd-html5-backend@14.0.2/dist/umd/ReactDnDHTML5Backend.min.js";import"https://unpkg.com/@arco-design/web-react@2.55.0/dist/arco.min.js";import"https://unpkg.com/@arco-design/web-react@2.55.0/dist/arco-icon.min.js";function _defineProperty$1(i,e,t){return e=_toPropertyKey$1(e),e in i?Object.defineProperty(i,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):i[e]=t,i}function _toPropertyKey$1(i){var e=_toPrimitive$1(i,"string");return typeof e=="symbol"?e:String(e)}function _toPrimitive$1(i,e){if(typeof i!="object"||i===null)return i;var t=i[Symbol.toPrimitive];if(t!==void 0){var r=t.call(i,e||"default");if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(i)}const _=window._;class ContextStore{constructor(item){_defineProperty$1(this,"item",void 0),_defineProperty$1(this,"isSave",!1),_defineProperty$1(this,"getTextFiles",async()=>await getContextToFileData(this.item)),_defineProperty$1(this,"parseFileToData",async text=>{const objs=await getTypeContext(text),{interfaces,default:defaultValue}=objs;if(defaultValue){const value=paramToStringify(eval(defaultValue));_.set(this.item,"extraInfo.default",value)}if(interfaces){const i=InterfaceToSchema(interfaces[0]);_.set(this.item,"props",i)}this.isSave=!0}),this.item=item}}const page="_page_41mpw_1",tabs="_tabs_41mpw_6",modal="_modal_41mpw_15",pageRight="_pageRight_41mpw_18",fullscreen="_fullscreen_41mpw_21";var styles={page,tabs,modal,pageRight,fullscreen},_class,_descriptor,_descriptor2,_descriptor3,_descriptor4,_descriptor5,_descriptor6,_descriptor7,_descriptor8,_descriptor9,_descriptor10,_descriptor11,_descriptor12;function _initializerDefineProperty(i,e,t,r){!t||Object.defineProperty(i,e,{enumerable:t.enumerable,configurable:t.configurable,writable:t.writable,value:t.initializer?t.initializer.call(r):void 0})}function _defineProperty(i,e,t){return e=_toPropertyKey(e),e in i?Object.defineProperty(i,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):i[e]=t,i}function _toPropertyKey(i){var e=_toPrimitive(i,"string");return typeof e=="symbol"?e:String(e)}function _toPrimitive(i,e){if(typeof i!="object"||i===null)return i;var t=i[Symbol.toPrimitive];if(t!==void 0){var r=t.call(i,e||"default");if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(i)}function _applyDecoratedDescriptor(i,e,t,r,s){var o={};return Object.keys(r).forEach(function(a){o[a]=r[a]}),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=t.slice().reverse().reduce(function(a,n){return n(i,e,a)||a},o),s&&o.initializer!==void 0&&(o.value=o.initializer?o.initializer.call(s):void 0,o.initializer=void 0),o.initializer===void 0&&(Object.defineProperty(i,e,o),o=null),o}const action=window.mobx.action,observable=window.mobx.observable,toJS$1=window.mobx.toJS,Message$1=window.arco.Message,Modal$1=window.arco.Modal;let Store=(_class=class{constructor(){_defineProperty(this,"code",new Store$2),_initializerDefineProperty(this,"PageElement",_descriptor,this),_initializerDefineProperty(this,"setPageElement",_descriptor2,this),_initializerDefineProperty(this,"updatePageElement",_descriptor3,this),_initializerDefineProperty(this,"pVisible",_descriptor4,this),_initializerDefineProperty(this,"setPVisible",_descriptor5,this),_initializerDefineProperty(this,"right",_descriptor6,this),_initializerDefineProperty(this,"setRight",_descriptor7,this),_defineProperty(this,"pathMap",{}),_initializerDefineProperty(this,"activeTab",_descriptor8,this),_initializerDefineProperty(this,"setActiveTab",_descriptor9,this),_defineProperty(this,"pageStore",{}),_defineProperty(this,"contexts",{}),_initializerDefineProperty(this,"tabList",_descriptor10,this),_initializerDefineProperty(this,"setTabList",_descriptor11,this),_initializerDefineProperty(this,"mode",_descriptor12,this),_defineProperty(this,"allComponents",async()=>{const e=Object.keys(this.pageStore);for(const t of e){const r=this.pageStore[t];if(r.isPage){const s=r.getData();if(s.components)for(const o of s.components){const a=moduleStore.elements.get(o);if(a.source==="custom")this.pageStore[a.key]||await this.addTab(a.key);else if(a.source==="context"){const n=new ContextStore(a),l=await n.getTextFiles();let c=`file://root/context/${a.name}.ts`;this.code.addFile(l,c),this.contexts[c]=n}}}}}),_defineProperty(this,"syncUpddatePageStore",async()=>{const e=`file:${this.code.uri.fsPath}`,t=this.contexts[e];if(t){const o=this.code.fileStores[this.code.uri.path];o&&(t.parseFileToData(o.dataStr),o.setOriginStr(o.dataStr));return}const r=this.pageStore[this.pathMap[e]],s=this.code.fileStores[this.code.uri.path];if(s){const o=s.dataStr;s.setLoading(!0);const n=this.code.uri.path.split("/").pop();if(n.endsWith(".less"))r.setLess(o),s.setOriginStr(o),s.setLoading(!1);else{switch(n){case"index.tsx":await r.parsePageIndexText(o).then(()=>{s.setOriginStr(o)}).catch(l=>{Message$1.warning(l)});break;case"store.tsx":case"store.ts":await r.parsePageStoreText(o).then(()=>{s.setOriginStr(o)}).catch(l=>{Message$1.warning(l)});break}s.setLoading(!1)}}this.right&&this.updatePageElement()})}async openModuleEidt(e){this.pageStore[e]?this.setActiveTab(e):(await this.addTab(e),this.setActiveTab(e))}async addTabPage({key:e,title:t,content:r,extraInfo:s}){const o={key:e,uid:e,title:t,name:t},a=new Store$3(o);s&&s.components&&await moduleStore.syncModuleIds(s.components),r&&await a.setData(r),this.pageStore[e]=a,this.setTabList([...toJS$1(this.tabList),o]),this.setActiveTab(o.key)}async addTab(e){const t=moduleStore.elements.get(e),r=t.extraInfo,s={key:e,uid:e,title:t.nickname||t.name,name:t.name,isComponent:t.source==="custom",isContext:t.source==="context"},o=new Store$3(s);r&&r.components&&await moduleStore.syncModuleIds(r.components),t.content&&await o.setData(t.content),this.pageStore[e]=o,this.setTabList([...toJS$1(this.tabList),s])}setMode(e){this.mode=e}async openCodeEditor(){let e;this.pathMap={},this.mode="code",await this.allComponents();for(const t in this.pageStore){const r=this.pageStore[t],{storeText:s,indexText:o}=await r.getTextFiles(),a=moduleStore.elements.get(t),n=r.isComponent?`components/${a.name}`:`pages/${r.uid}`;this.code.contentAlias[r.uid]=r.name;let l=`file://root/${n}/style.less`,c=`file://root/${n}/store.ts`,p=`file://root/${n}/index.tsx`;this.code.addFile(r.lessStr,l),this.code.addFile(s,c),e=this.code.addFile(o,p),r.uid===this.activeTab&&this.code.openFile(e.uri),this.pathMap=Object.assign(this.pathMap,{[l]:r.uid,[c]:r.uid,[p]:r.uid})}}openCavnasEditor(){const t=Object.values(this.contexts).filter(r=>r.isSave);if(t.length){const r=t.map(s=>s.item.nickname||s.item.name).join(",");Modal$1.confirm({title:"\u4FDD\u5B58\u63D0\u793A",content:`${r} \u7B49context\u7EC4\u4EF6\u8FD8\u672A\u4FDD\u5B58\uFF0C\u662F\u5426\u7EE7\u7EED\u5207\u6362`,onOk:()=>{this.setMode("canvas")}})}else this.setMode("canvas")}async saveData(){if(this.mode==="canvas"){const e=this.pageStore[this.activeTab];return this.savePageData(e)}else if(this.mode==="code"){const e=`file:${this.code.uri.fsPath}`,t=this.contexts[e];if(t){const r=t.item;return ajax.post("/apijson/put",{Module:{id:this.activeTab,props:t.item.props,extraInfo:t.item.extraInfo}}).then(()=>{Message$1.success(`${r.nickname||r.name} \u6A21\u5757\u4FDD\u5B58\u6210\u529F`),moduleStore.updateElement(this.activeTab,r)})}else{const r=this.pageStore[this.pathMap[e]];return this.savePageData(r)}}}async savePageData(e){if(console.log("savePageData",e),e.isComponent){const t=moduleStore.elements.get(e.uid);await e.validate().then(async r=>{const s={props:r.page.props,content:r,extraInfo:d(u({},t.extraInfo),{cssStr:r.cssStr,components:r.components}),jsxRender:await e.getRenderText()};return ajax.post("/apijson/put",{Module:d(u({id:e.uid},s),{content:JSON.stringify(r)})}).then(()=>{Message$1.success(`${t.nickname||t.name} \u6A21\u5757\u4FDD\u5B58\u6210\u529F`),moduleStore.updateElement(e.uid,u(u({},t),s))})})}else await e.validate().then(async t=>ajax.post("/apijson/put",{Page:{id:e.uid,content:JSON.stringify(t),extraInfo:{cssStr:t.cssStr,components:t.components},jsxRender:await e.getRenderText()}}).then(()=>{Message$1.success("\u9875\u9762\u4FDD\u5B58\u6210\u529F")}))}},_descriptor=_applyDecoratedDescriptor(_class.prototype,"PageElement",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return()=>null}}),_descriptor2=_applyDecoratedDescriptor(_class.prototype,"setPageElement",[action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return i=>{this.PageElement=i}}}),_descriptor3=_applyDecoratedDescriptor(_class.prototype,"updatePageElement",[action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return async()=>{const i=this.pageStore[this.activeTab];if(i){const e=await i.getRenderText();this.setPageElement(dynamicCreateModule(e))}}}}),_descriptor4=_applyDecoratedDescriptor(_class.prototype,"pVisible",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor5=_applyDecoratedDescriptor(_class.prototype,"setPVisible",[action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return i=>{this.pVisible=i}}}),_descriptor6=_applyDecoratedDescriptor(_class.prototype,"right",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor7=_applyDecoratedDescriptor(_class.prototype,"setRight",[action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return i=>{this.right=i}}}),_descriptor8=_applyDecoratedDescriptor(_class.prototype,"activeTab",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_descriptor9=_applyDecoratedDescriptor(_class.prototype,"setActiveTab",[action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return i=>{this.activeTab=i}}}),_descriptor10=_applyDecoratedDescriptor(_class.prototype,"tabList",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_descriptor11=_applyDecoratedDescriptor(_class.prototype,"setTabList",[action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return i=>{this.tabList=i}}}),_applyDecoratedDescriptor(_class.prototype,"openModuleEidt",[action],Object.getOwnPropertyDescriptor(_class.prototype,"openModuleEidt"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"addTab",[action],Object.getOwnPropertyDescriptor(_class.prototype,"addTab"),_class.prototype),_descriptor12=_applyDecoratedDescriptor(_class.prototype,"mode",[observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"canvas"}}),_applyDecoratedDescriptor(_class.prototype,"setMode",[action],Object.getOwnPropertyDescriptor(_class.prototype,"setMode"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"openCodeEditor",[action],Object.getOwnPropertyDescriptor(_class.prototype,"openCodeEditor"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"openCavnasEditor",[action],Object.getOwnPropertyDescriptor(_class.prototype,"openCavnasEditor"),_class.prototype),_class);var Store$1=Store;const useEffect=window.React.useEffect,useState=window.React.useState,useHistory=window.ReactRouterDOM.useHistory,Button=window.arco.Button,Tabs=window.arco.Tabs,Space=window.arco.Space,Spin=window.arco.Spin,Message=window.arco.Message,Empty=window.arco.Empty,Modal=window.arco.Modal,useObserver=window.mobxReact.useObserver,toJS=window.mobx.toJS,IconCalendar=window.arcoicon.IconCalendar,IconCommon=window.arcoicon.IconCommon,IconCopy=window.arcoicon.IconCopy,IconToRight=window.arcoicon.IconToRight,{TabPane}=Tabs;var index=()=>{const i=useHistory(),[e]=useState(()=>getQueryParam(i.location.search,"pageId")),[t,r]=useState(!1),[s]=useState(()=>new Store$1);return useEffect(()=>{!e||(r(!0),ajax.post("/apijson/get",{Page:{id:e}}).then(o=>{if(o.Page){const{content:a,extraInfo:n}=o.Page;a?s.addTabPage({key:e,title:o.Page.title,content:JSON.parse(a),extraInfo:JSON.parse(n)}):s.addTabPage({key:e,title:o.Page.title,content:null,extraInfo:null})}else Message.error("\u5F53\u524D\u9875\u9762\u4E0D\u5B58\u5728")}).finally(()=>{r(!1)}))},[e]),e?useObserver(()=>{const{activeTab:o,setActiveTab:a}=s,n=toJS(s.tabList);useEffect(()=>{if(s.mode==="code"){const c=p=>{p.key==="s"&&(p.ctrlKey||p.metaKey)&&s.syncUpddatePageStore()};return document.addEventListener("keydown",c),()=>{document.removeEventListener("keydown",c)}}},[s.mode]);const{PageElement:l}=s;return jsxs("div",{className:`page-container ${styles.page}`,children:[s.mode==="code"?jsx(MyComponent,{store:s.code,extra:jsxs(Space,{children:[jsx(Button,{type:"primary",size:"small",onClick:()=>{s.openCavnasEditor()},children:"\u53EF\u89C6\u5316"},"1"),jsx(Button,{type:"primary",size:"small",onClick:()=>{s.updatePageElement(),!s.right&&s.setPVisible(!0)},children:"\u9884\u89C8"},"3"),jsx(AsyncButton,{size:"small",type:"primary",onClick:()=>s.saveData(),children:"\u4FDD\u5B58"},"save"),jsx(Button,{type:"primary",size:"small",onClick:()=>{s.syncUpddatePageStore()},children:"\u6267\u884C"},"2")]},"0"),right:s.right?jsxs("div",{children:[jsx(Tabs,{type:"card",extra:jsx(Button,{onClick:()=>{s.setPVisible(!0),s.setRight(!1)},size:"small",type:"primary",icon:jsx(IconCopy,{})}),children:jsx(TabPane,{title:"\u9884\u89C8"},"1")}),jsx("div",{className:styles.pageRight,children:jsx(MyErrorBoundary,{children:jsx(l,{})})})]}):""}):jsxs(Tabs,{type:"card-gutter",activeTab:o,className:styles.tabs,onChange:a,extra:jsxs(Space,{children:[jsx(Button,{size:"small",type:"secondary",onClick:()=>{i.goBack()},children:"\u8FD4\u56DE"},"1"),jsx(AsyncButton,{size:"small",type:"primary",onClick:()=>s.saveData(),children:"\u4FDD\u5B58"},"2"),jsx(Button,{size:"small",type:"primary",onClick:()=>{s.openCodeEditor()},children:"VsCode"},"3")]}),children:[t&&jsx(Spin,{}),n.map(c=>jsx(TabPane,d(u({destroyOnHide:!0},c),{title:jsxs("span",{children:[c.isComponent?jsx(IconCommon,{style:{marginRight:6}}):jsx(IconCalendar,{style:{marginRight:6}}),c.title]}),children:jsx(CustomPage,{store:s.pageStore[c.key],openModuleEidt:p=>s.openModuleEidt(p)})})))]}),jsx(Modal,{title:jsxs("div",{style:{textAlign:"left",display:"flex",alignItems:"center"},children:["\u9884\u89C8",jsx(IconToRight,{onClick:()=>{s.setPVisible(!1),s.setRight(!0)},style:{fontSize:"24px",marginLeft:"8px"}})]}),visible:s.pVisible,className:`${styles.modal} ${styles.fullscreen} arco-modal-page-html`,footer:null,maskClosable:!1,onCancel:()=>{s.setPVisible(!1)},children:jsx(MyErrorBoundary,{children:jsx(l,{})})})]})}):jsx(Empty,{})};export{index as default};
